package net.jpmchase.payroll.event.aspect;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import net.jpmchase.payroll.event.model.PyrlEventLog;
import net.jpmchase.payroll.event.repository.PyrlEventLogRepository;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.AfterReturning;
import org.aspectj.lang.annotation.AfterThrowing;
import org.aspectj.lang.annotation.Aspect;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.Optional;
import java.util.UUID;

@Aspect
@Component
@RequiredArgsConstructor
@Slf4j
public class EventLogAspect {

    private final PyrlEventLogRepository eventLogRepository;
    private final ObjectMapper objectMapper;

    private static final int MAX_RETRIES = 3;
    private static final String SYSTEM_USER = "SYSTEM";

    @AfterReturning(value = "@annotation(LogEvent)", returning = "result")
    public void logSuccessEvent(JoinPoint joinPoint, Object result) {
        log.info("[EVENT-LOG] Processing success for method: {}", joinPoint.getSignature().getName());

        try {
            JsonNode jsonNode = parseJson(result);
            if (jsonNode == null) {
                log.warn("[EVENT-LOG] Skipping event log update: Unable to parse JSON from result.");
                return;
            }

            PyrlEventLog eventLog = createOrUpdateEventLog(jsonNode, "SUCCESS", 0, null);
            eventLogRepository.save(eventLog);
            log.info("[EVENT-LOG] Event logged successfully: EventID={}, EventType={}", eventLog.getSrcEvntId(), eventLog.getSrcEvntType());

        } catch (Exception e) {
            log.error("[EVENT-LOG] Error while logging success event for {}: {}", joinPoint.getSignature().getName(), e.getMessage(), e);
        }
    }

    @AfterThrowing(value = "@annotation(LogEvent)", throwing = "exception")
    public void logFailedEvent(JoinPoint joinPoint, Exception exception) {
        log.error("[EVENT-LOG] Exception occurred during event processing for method: {}", joinPoint.getSignature().getName(), exception);

        try {
            Optional<PyrlEventLog> existingLog = eventLogRepository.findTopByOrderByCreTsDesc();
            PyrlEventLog eventLog;

            if (existingLog.isPresent()) {
                eventLog = existingLog.get();
                int retryCount = eventLog.getRetryCount();

                if (retryCount < MAX_RETRIES) {
                    eventLog.setRetryCount(retryCount + 1);
                    eventLog.setSrcEvntSts("RETRYING");
                    log.info("[EVENT-LOG] Retrying event {} - Attempt {}/{}", eventLog.getSrcEvntId(), retryCount + 1, MAX_RETRIES);
                } else {
                    eventLog.setSrcEvntSts("PERMANENTLY_FAILED");
                    eventLog.setStatusRsn(exception.getMessage());
                    log.warn("[EVENT-LOG] Event {} permanently failed after {} retries", eventLog.getSrcEvntId(), MAX_RETRIES);
                }
                eventLog.setUpdtTs(LocalDateTime.now());
                eventLog.setUpdtUsrId(SYSTEM_USER);

            } else {
                eventLog = createOrUpdateEventLog(null, "FAILED", 1, exception.getMessage());
                log.info("[EVENT-LOG] Created new failed event log entry.");
            }

            eventLogRepository.save(eventLog);

        } catch (Exception e) {
            log.error("[EVENT-LOG] Error while logging failure for event: {}", joinPoint.getSignature().getName(), e);
        }
    }

    private JsonNode parseJson(Object result) {
        if (result == null) return null;
        try {
            return objectMapper.readTree(objectMapper.writeValueAsString(result));
        } catch (Exception e) {
            log.error("[EVENT-LOG] Error parsing JSON from result: {}", e.getMessage());
            return null;
        }
    }

    private PyrlEventLog createOrUpdateEventLog(JsonNode jsonNode, String status, int retryCount, String failureReason) {
        String eventUuid = getJsonField(jsonNode, "uuid", UUID.randomUUID().toString());
        String eventType = getJsonField(jsonNode, "event_type", "UNKNOWN");
        String resourceType = getJsonField(jsonNode, "resource_type", "UNKNOWN");
        String resourceUuid = getJsonField(jsonNode, "resource_uuid", UUID.randomUUID().toString());
        String entityType = getJsonField(jsonNode, "entity_type", "UNKNOWN");
        String entityUuid = getJsonField(jsonNode, "entity_uuid", UUID.randomUUID().toString());

        Optional<PyrlEventLog> existingLog = eventLogRepository.findBySrcEvntId(eventUuid);
        PyrlEventLog eventLog = existingLog.orElseGet(() -> PyrlEventLog.builder()
                .pyrlEvntLogId(UUID.randomUUID())
                .srcEvntId(eventUuid)
                .srcEvntType(eventType)
                .srcEvntTs(LocalDateTime.now())
                .resourceType(resourceType)
                .resourceId(resourceUuid)
                .entityType(entityType)
                .entityId(entityUuid)
                .creTs(LocalDateTime.now())
                .creUsrId(SYSTEM_USER)
                .build());

        eventLog.setSrcEvntSts(status);
        eventLog.setRetryCount(retryCount);
        eventLog.setStatus(status);
        eventLog.setStatusRsn(failureReason);
        eventLog.setUpdtTs(LocalDateTime.now());
        eventLog.setUpdtUsrId(SYSTEM_USER);

        return eventLog;
    }

    private String getJsonField(JsonNode jsonNode, String fieldName, String defaultValue) {
        return jsonNode != null && jsonNode.has(fieldName) ? jsonNode.get(fieldName).asText() : defaultValue;
    }
}

